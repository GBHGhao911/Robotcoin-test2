<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dataset Visualizer</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        }

        h1,
        h3 {
            font-weight: 600;
            background: linear-gradient(90deg, #007bff, #00c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* 给整个标签栏加滚动条 */
        #filters {
            max-height: 75vh;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
        }

        #filters h5 {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 10px;
            border-left: 3px solid #007bff;
            padding-left: 6px;
        }

        /* 去掉物品树的缩进 */
        #filters ul {
            list-style: none;
            padding-left: 0;
            margin-left: 0;
        }

        .video-card {
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 120px;
            cursor: pointer;
        }

        .video-card:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .video-card video {
            border-radius: 8px;
            background: #000;
            display: block;
        }

        .video-card.selected video {
            border: 3px solid orange !important;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.65);
            opacity: 0;
            transition: opacity 0.25s ease;
            color: white;
            display: flex;
            justify-content: center;
            text-align: center;
            align-items: center;
            font-size: 0.8rem;
            padding: 5px;
            z-index: 10;
            pointer-events: none;
        }

        .video-card:hover .video-overlay {
            opacity: 1;
        }

        .checkbox-container {
            font-size: 0.95rem;
            margin-bottom: -0.25rem;
        }

        .tree-toggle {
            cursor: pointer;
            color: gray;
            font-size: 0.9rem;
            display: inline-block;
            width: 1em;
            text-align: center;
            margin-left: 4px;
        }

        .nested {
            display: none;
        }

        .expanded>.nested {
            display: block;
        }

        #downloadCommand {
            font-family: monospace;
            background: #f5f5f5;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div class="container mt-3">
        <div class="row">
            <h1 class="d-md-block d-none">Dataset Visualizer</h1>
            <h3 class="d-block d-md-none">Dataset Visualizer</h3>
        </div>

        <div class="row">
            <div class="col-md-2 px-1 col-12">
                <div class="mb-2">
                    <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="搜索数据集名字">
                </div>
                <div class="btn-group d-flex mb-2" role="group">
                    <button id="selectAllBtn" class="btn btn-sm btn-outline-primary flex-fill">全选</button>
                    <button id="clearSelectionBtn" class="btn btn-sm btn-outline-secondary flex-fill">清空选择</button>
                    <button id="downloadBtn" class="btn btn-sm btn-outline-success flex-fill">下载</button>
                </div>
                <div id="filters"></div>
                <div id="filterError" style="color:red; display:none;"></div>
            </div>

            <div class="col">
                <div class="row" id="video-list"></div>
                <div class="d-flex justify-content-center my-3">
                    <button class="btn btn-outline-dark btn-sm mx-1" id="prevPage">上一页</button>
                    <span class="align-self-center" id="pageInfo"></span>
                    <button class="btn btn-outline-dark btn-sm mx-1" id="nextPage">下一页</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载命令模态框 -->
    <div class="modal fade" id="downloadModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">下载命令</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div>
                        <label><input type="radio" name="hubOption" value="huggingface" checked> HuggingFace</label>
                        <label class="ml-3"><input type="radio" name="hubOption" value="modelscope"> ModelScope</label>
                    </div>
                    <textarea id="downloadCommand" class="form-control mt-2" rows="8" readonly></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            document.addEventListener('DOMContentLoaded', () => {
                const filters = document.getElementById('filters');
                const searchBox = document.getElementById('searchBox');
                const videoList = document.getElementById('video-list');
                const pageInfo = document.getElementById('pageInfo');
                const prevPageBtn = document.getElementById('prevPage');
                const nextPageBtn = document.getElementById('nextPage');
                const filterError = document.getElementById('filterError');

                const selectAllBtn = document.getElementById('selectAllBtn');
                const clearSelectionBtn = document.getElementById('clearSelectionBtn');
                const downloadBtn = document.getElementById('downloadBtn');

                let datasets = [];
                let currentDatasets = [];
                const itemsPerPage = 40;
                let currentPage = 1;
                let totalPages = 1;

                let selectedDatasets = new Set();

                const jsyamlLib = window.jsyaml;

                const chineseToEnglishMapping = {
                    "任务内容": "name",
                    "描述": "description",
                    "场景类型": "scene",
                    "采集本体": "robot",
                    "末端类型": "end",
                    "相机数量": "cameraCount",
                    "相机类型": "cameraType",
                    "声音传感器数量": "soundSensors",
                    "触觉传感器数量": "tactileSensors",
                    "原子动作": "action",
                    "物品": "item",
                    "桌面高度": "tableHeight",
                    "机器人高度": "robotHeight"
                };

                function escapeHtml(str) {
                    if (str === null || str === undefined) return '';
                    return String(str).replace(/[&<>'"]/g, s => ({
                        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
                    }[s]));
                }

                async function loadDatasets() {
                    try {
                        const indexRes = await fetch('dataset_info/data_index.json');
                        const fileList = await indexRes.json();

                        datasets = [];
                        let idCounter = 1;
                        for (const fileName of fileList) {
                            const res = await fetch('dataset_info/' + fileName);
                            const yamlText = await res.text();
                            let raw = jsyamlLib.load(yamlText);
                            const ds = {};

                            for (const [cnKey, val] of Object.entries(raw || {})) {
                                const enKey = chineseToEnglishMapping[cnKey] || cnKey;

                                if (enKey === "description" && val !== undefined && val !== null) {
                                    ds[enKey] = String(val);
                                } 
                                // 物品处理（支持数组 / 对象 / 单值）
                                else if (enKey === "item") {
                                    console.log("物品字段原始值:", val, "类型:", typeof val, "是否数组:", Array.isArray(val));

                                    ds[enKey] = [];
                                    let items = [];

                                    if (Array.isArray(val)) {
                                        items = val;
                                    } else if (typeof val === "object" && val !== null) {
                                        items = Object.values(val); // 数字键对象 → 数组
                                    } else if (val) {
                                        items = [val];
                                    }

                                    for (let idx = 0; idx < items.length; idx++) {
                                        const itemObj = items[idx];
                                        const levels = [];

                                        for (let i = 1; i <= 5; i++) {
                                            const key = "level" + i;
                                            if (itemObj[key] && itemObj[key] !== "null") {
                                                levels.push(String(itemObj[key]).trim());
                                            }
                                        }

                                        if (levels.length > 0) {
                                            ds[enKey].push(levels);
                                        }
                                    }


                                } 
                                // 声音 / 触觉传感器保存为字符串
                                else if (enKey === "soundSensors" || enKey === "tactileSensors") {
                                    ds[enKey] = (val !== undefined && val !== null) ? String(val) : "0";
                                } 
                                else {
                                    ds[enKey] = val;
                                }
                            }

                            ds.path = String(fileName).replace(/\.yml$/i, '');
                            ds.id = String(idCounter++);
                            datasets.push(ds);
                            
                            debugger ;
                        }

                        buildAllCheckboxGroups(datasets);
                        buildItemTree(datasets); // 构建物品树
                        applyFilters();
                    } catch (err) {
                        filterError.textContent = '加载数据失败: ' + err.message;
                        filterError.style.display = 'block';
                        console.error("加载数据失败:", err);
                    }
                }

                function buildAllCheckboxGroups(datasets) {
                    filterSection.innerHTML = '';

                    for (const [cnKey, enKey] of Object.entries(chineseToEnglishMapping)) {
                        // 跳过不需要生成复选框的字段
                        if (["name", "description", "path", "id", "item"].includes(enKey)) continue;

                        const valueSet = new Set();

                        // ✅ 改成 for 循环，确保稳定
                        for (let i = 0; i < datasets.length; i++) {
                            const ds = datasets[i];

                            if (Array.isArray(ds[enKey])) {
                                for (let j = 0; j < ds[enKey].length; j++) {
                                    valueSet.add(String(ds[enKey][j]).trim());
                                }
                            } else if (ds[enKey] !== undefined && ds[enKey] !== null) {
                                valueSet.add(String(ds[enKey]).trim());
                            }
                        }

                        if (valueSet.size > 0) {
                            buildGroup(filterSection, cnKey, enKey, valueSet);
                        }
                    }
                }


                function buildGroup(container, title, cssClass, valuesSet) {
                    const values = Array.from(valuesSet).sort();
                    let html = '<h5 class="mb-1">' + escapeHtml(title) + '</h5>';
                    html += '<div class="checkbox-container"><label><input type="checkbox" id="' + cssClass + '-all-checkbox" checked> 全部</label></div>';
                    values.forEach((val, i) => {
                        const id = cssClass + '-' + (i + 1);
                        const safeVal = String(val).trim();
                        html += '<div class="checkbox-container"><label><input type="checkbox" class="' 
                            + cssClass + '-checkbox" data-field="' + cssClass + '" id="' + id + '" value="' 
                            + escapeHtml(safeVal) + '"> ' 
                            + escapeHtml(safeVal) 
                            + ' <small class="text-muted">(<span id="' + id + '-count">0</span>)</small></label></div>';
                    });
                    const block = document.createElement('div');
                    block.innerHTML = html;
                    container.appendChild(block);

                    block.addEventListener('change', (e) => {
                        const allBox = block.querySelector('#' + cssClass + '-all-checkbox');
                        const children = Array.from(block.querySelectorAll('.' + cssClass + '-checkbox'));

                        if (e.target === allBox) {
                            if (allBox.checked) children.forEach(cb => cb.checked = false);
                        } else if (e.target.classList.contains(cssClass + '-checkbox')) {
                            const anyChecked = children.some(cb => cb.checked);
                            allBox.checked = !anyChecked;
                        }
                        applyFilters();
                    });
                }

                function buildItemTree(datasets) {
                    const tree = {};

                    // 构建分类树
                    datasets.forEach(ds => {
                        if (Array.isArray(ds.item)) {
                            ds.item.forEach(path => {
                                let node = tree;

                                if (Array.isArray(path)) {
                                    // 新结构: ["food","bread"]
                                    path.forEach(level => {
                                        if (!node[level]) node[level] = {};
                                        node = node[level];
                                    });
                                } else if (typeof path === "string") {
                                    // 旧结构: "food/bread"
                                    path.trim().split('/').forEach(level => {
                                        if (!node[level]) node[level] = {};
                                        node = node[level];
                                    });
                                }
                            });
                        }
                    });

                    // 渲染分类树
                    function renderNode(node, prefix) {
                        let html = "<ul class='item-tree'>";
                        Object.keys(node).sort().forEach((key, i) => {
                            const id = prefix + '-' + i;
                            const safeKey = escapeHtml(key);
                            html += `<li>
                                        <label>
                                        <input type="checkbox" class="item-checkbox" data-field="item" id="${id}" value="${safeKey}">
                                        ${safeKey} 
                                        <small class="text-muted">(<span id="${id}-count">0</span>)</small>
                                        </label>`;
                            html += renderNode(node[key], id);
                            html += `</li>`;
                        });
                        html += "</ul>";
                        return html;
                    }

                    const html = '<h5 class="mb-1">物品</h5>' +
                                '<div class="checkbox-container"><label><input type="checkbox" id="item-all-checkbox" checked> 全部</label></div>' +
                                renderNode(tree, "item");

                    const block = document.createElement('div');
                    block.innerHTML = html;
                    itemFilter.appendChild(block);

                    // 绑定全选/取消全选事件
                    block.addEventListener('change', (e) => {
                        const allBox = document.getElementById("item-all-checkbox");
                        const children = Array.from(block.querySelectorAll('.item-checkbox'));

                        if (e.target === allBox) {
                            if (allBox.checked) children.forEach(cb => cb.checked = false);
                        } else if (e.target.classList.contains("item-checkbox")) {
                            const anyChecked = children.some(cb => cb.checked);
                            allBox.checked = !anyChecked;
                        }
                        applyFilters();
                    });
                }



                function applyFilters() {

                    console.log("当前映射表:", chineseToEnglishMapping);
                    console.log("某个数据集:", currentDatasets[0]);


                    selectedDatasets.clear();
                    const q = (searchBox && searchBox.value) ? String(searchBox.value).trim().toLowerCase() : '';

                    const activeFilters = {};
                    for (const [cnKey, enKey] of Object.entries(chineseToEnglishMapping)) {

                        console.log("正在统计字段:", enKey);


                        if (["name", "description", "path", "id"].includes(enKey)) continue;
                        if (enKey === "item") {
                            const checked = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
                            if (checked.length > 0) activeFilters[enKey] = checked;
                        } else {
                            const allBox = document.getElementById(enKey + '-all-checkbox');
                            if (allBox && !allBox.checked) {
                                const checked = Array.from(document.querySelectorAll('.' + enKey + '-checkbox:checked')).map(cb => cb.value);
                                if (checked.length > 0) activeFilters[enKey] = checked;
                            }
                        }
                    }

                    currentDatasets = datasets.filter(ds => {
                        if (q) {
                            const name = String(ds.name || ds.path || '').toLowerCase();
                            if (!name.includes(q)) return false;
                        }
                        for (const [key, vals] of Object.entries(activeFilters)) {
                            if (Array.isArray(ds[key])) {
                                if (!ds[key].some(v => vals.includes(String(v)))) return false;
                            } else if (ds[key] !== undefined && ds[key] !== null) {
                                if (!vals.includes(String(ds[key]))) return false;
                            } else {
                                return false;
                            }
                        }
                        return true;
                    });

                    debugger ; 
                    // 修复统计 key 的类型问题（保证数字 0 也能统计到）
                    for (const [cnKey, enKey] of Object.entries(chineseToEnglishMapping)) {
                        if (["name", "description", "path", "id"].includes(enKey)) continue;
                        const counts = {};
                        currentDatasets.forEach(ds => {
                            if (Array.isArray(ds[enKey])) {
                                ds[enKey].forEach(v => {
                                    const key = String(v).trim();
                                    counts[key] = (counts[key] || 0) + 1;
                                });
                            } else if (ds[enKey] !== undefined && ds[enKey] !== null) {
                                const key = String(ds[enKey]).trim();
                                counts[key] = (counts[key] || 0) + 1;
                            }
                        });
                        for (const [val, num] of Object.entries(counts)) {
                            const checkbox = document.querySelector(
                                'input[data-field="' + enKey + '"][value="' + CSS.escape(val) + '"]'
                            );
                            if (checkbox) {
                                const id = checkbox.id + '-count';
                                const el = document.getElementById(id);
                                if (el) el.textContent = num;
                            }
                        }
                    }


                    totalPages = Math.max(1, Math.ceil(currentDatasets.length / itemsPerPage));
                    currentPage = 1;
                    renderVideos();
                }


                function renderVideos() {
                    const start = (currentPage - 1) * itemsPerPage;
                    const pageData = currentDatasets.slice(start, start + itemsPerPage);
                    videoList.innerHTML = '';
                    pageData.forEach(ds => {
                        const col = document.createElement('div');
                        col.className = 'col-md-3 p-1 d-flex position-relative video-card';
                        if (selectedDatasets.has(ds.path)) col.classList.add('selected');

                        const video = document.createElement('video');
                        video.className = 'border w-100';
                        video.autoplay = true; video.loop = true; video.muted = true; video.playsInline = true;

                        const source = document.createElement('source');
                        source.src = 'videos/' + ds.path + '.mp4';
                        source.type = 'video/mp4';
                        video.appendChild(source);

                        const overlay = document.createElement('div');
                        overlay.className = 'video-overlay p-3';
                        overlay.innerHTML = `<span><b>${escapeHtml(ds.name || ds.path)}</b><br>${escapeHtml(ds.description || '')}</span>`;

                        col.appendChild(video);
                        col.appendChild(overlay);

                        col.addEventListener('click', () => {
                            if (selectedDatasets.has(ds.path)) {
                                selectedDatasets.delete(ds.path);
                                col.classList.remove('selected');
                            } else {
                                selectedDatasets.add(ds.path);
                                col.classList.add('selected');
                            }
                        });

                        videoList.appendChild(col);
                    });

                    pageInfo.textContent = '第 ' + currentPage + ' / 共 ' + totalPages + ' 页';
                    prevPageBtn.disabled = currentPage <= 1;
                    nextPageBtn.disabled = currentPage >= totalPages;
                }

                selectAllBtn.addEventListener('click', () => {
                    selectedDatasets.clear();
                    currentDatasets.forEach(ds => selectedDatasets.add(ds.path));
                    renderVideos();
                });

                clearSelectionBtn.addEventListener('click', () => {
                    selectedDatasets.clear();
                    renderVideos();
                });

                function generateDownloadCommand() {
                    const hub = document.querySelector('input[name="hubOption"]:checked').value;
                    let cmd = `python -m robotcoin.datasets.download --hub ${hub} --ds_lists " \\\n`;
                    Array.from(selectedDatasets).sort().forEach(path => {
                        cmd += path + " \\\n";
                    });
                    cmd += `"`;
                    document.getElementById('downloadCommand').value = cmd;
                }

                downloadBtn.addEventListener('click', () => {
                    generateDownloadCommand();
                    $('#downloadModal').modal('show');
                });

                document.querySelectorAll('input[name="hubOption"]').forEach(radio => {
                    radio.addEventListener('change', generateDownloadCommand);
                });

                prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderVideos(); } });
                nextPageBtn.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderVideos(); } });
                if (searchBox) searchBox.addEventListener('input', applyFilters);

                loadDatasets();
            });
        })();
    </script>


</body>

</html>