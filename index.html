<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DROID Dataset Visualizer (Modified)</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

    <style>
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.65);
            opacity: 0;
            transition: opacity 0.25s ease;
            color: white;
            display: flex;
            justify-content: center;
            text-align: center;
            align-items: center;
            font-size: 0.75rem;
            padding: 5px;
            z-index: 10;
            pointer-events: none;
        }

        .video-card:hover .video-overlay {
            opacity: 1;
        }

        .checkbox-container {
            font-size: 0.9rem;
            margin-bottom: -0.25rem;
        }

        .video-card {
            min-height: 120px;
            cursor: pointer;
        }

        .video-card.selected video {
            border: 3px solid orange !important;
        }

        video.border {
            background: #000;
            display: block;
        }

        #filters {
            max-height: 80vh;
            overflow-y: auto;
        }

        .tree-toggle {
            cursor: pointer;
            color: gray;
            font-size: 0.9rem;
            display: inline-block;
            width: 1em;
            text-align: center;
            margin-left: 4px;
        }

        .nested {
            display: none;
        }

        .expanded>.nested {
            display: block;
        }

        #filters ul {
            list-style: none;
            padding-left: 0;
        }

        #filters li {
            margin: 2px 0;
        }
    </style>
</head>

<body>
    <div class="container mt-3">
        <div class="row">
            <h1 class="d-md-block d-none">DROID Dataset Visualizer</h1>
            <h3 class="d-block d-md-none">DROID Dataset Visualizer</h3>
        </div>

        <div class="row">
            <div class="col-md-2 px-1 col-12">
                <div class="mb-2">
                    <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="搜索数据集名字">
                </div>
                <!-- 等宽按钮 -->
                <div class="btn-group d-flex mb-2" role="group">
                    <button id="selectAllBtn" class="btn btn-sm btn-outline-primary flex-fill">全选</button>
                    <button id="clearSelectionBtn" class="btn btn-sm btn-outline-secondary flex-fill">清空选择</button>
                    <button id="downloadBtn" class="btn btn-sm btn-outline-success flex-fill">下载</button>
                </div>
                <div id="filters"></div>
                <div id="filterError" style="color:red; display:none;"></div>
            </div>

            <div class="col">
                <div class="row" id="video-list"></div>
                <div class="d-flex justify-content-center my-3">
                    <button class="btn btn-outline-dark btn-sm mx-1" id="prevPage">上一页</button>
                    <span class="align-self-center" id="pageInfo"></span>
                    <button class="btn btn-outline-dark btn-sm mx-1" id="nextPage">下一页</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载命令模态框 -->
    <div class="modal fade" id="downloadModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">下载命令</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div>
                        <label><input type="radio" name="hubOption" value="huggingface" checked> HuggingFace</label>
                        <label class="ml-3"><input type="radio" name="hubOption" value="modelscope"> ModelScope</label>
                    </div>
                    <textarea id="downloadCommand" class="form-control mt-2" rows="8" readonly></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="container mt-3 text-center small">
        <p>Dataset visualizer built by Jimmy Wu. Adapted to dynamic datasets.</p>
    </footer>

    <script>
        (function () {
            document.addEventListener('DOMContentLoaded', () => {
                const filters = document.getElementById('filters');
                const searchBox = document.getElementById('searchBox');
                const videoList = document.getElementById('video-list');
                const pageInfo = document.getElementById('pageInfo');
                const prevPageBtn = document.getElementById('prevPage');
                const nextPageBtn = document.getElementById('nextPage');
                const filterError = document.getElementById('filterError');

                const selectAllBtn = document.getElementById('selectAllBtn');
                const clearSelectionBtn = document.getElementById('clearSelectionBtn');
                const downloadBtn = document.getElementById('downloadBtn');

                let datasets = [];
                let currentDatasets = [];
                const itemsPerPage = 40;
                let currentPage = 1;
                let totalPages = 1;

                let selectedDatasets = new Set();

                const jsyamlLib = window.jsyaml;
                if (!jsyamlLib) {
                    filterError.textContent = '需要 js-yaml 库，请确保页面能加载 https://cdn.jsdelivr.net/npm/js-yaml';
                    filterError.style.display = 'block';
                    return;
                }

                const chineseToEnglishMapping = {
                    "任务内容": "name",
                    "描述": "description",
                    "场景类型": "scene",
                    "采集本体": "robot",
                    "末端类型": "end",
                    "相机数量": "cameraCount",
                    "相机类型": "cameraType",
                    "声音传感器数量": "soundSensors",
                    "触觉传感器数量": "tactileSensors",
                    "原子动作": "action",
                    "物品": "item",
                    "桌面高度": "tableHeight",
                    "机器人高度": "robotHeight"
                };

                function escapeHtml(str) {
                    if (str === null || str === undefined) return '';
                    return String(str).replace(/[&<>'"]/g, s => ({
                        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
                    }[s]));
                }

                async function loadDatasets() {
                    try {
                        filterError.style.display = 'none';
                        const indexRes = await fetch('dataset_info/data_index.json');
                        if (!indexRes.ok) throw new Error('无法加载 dataset_info/data_index.json: ' + indexRes.status);
                        const fileList = await indexRes.json();
                        if (!Array.isArray(fileList)) throw new Error('data_index.json 必须是文件名数组');

                        datasets = [];
                        let idCounter = 1;
                        for (const fileName of fileList) {
                            try {
                                const res = await fetch('dataset_info/' + fileName);
                                if (!res.ok) { console.warn('无法加载', fileName); continue; }
                                const yamlText = await res.text();
                                let raw;
                                try { raw = jsyamlLib.load(yamlText); } catch (e) { console.warn('YAML 解析失败', fileName, e); continue; }
                                const ds = {};
                                for (const [cnKey, val] of Object.entries(raw || {})) {
                                    const cleanKey = cnKey.replace(/^\uFEFF/, ''); // 去掉BOM
                                    const enKey = chineseToEnglishMapping[cleanKey] || cleanKey;
                                    if (enKey === "description" && val !== undefined && val !== null) {
                                        ds[enKey] = String(val);
                                    } else {
                                        ds[enKey] = val;
                                    }
                                }
                                ds.path = String(fileName).replace(/\.yml$/i, '');
                                ds.id = String(idCounter++);
                                datasets.push(ds);
                            } catch (e) { console.warn('单文件加载失败', fileName, e); }
                        }

                        if (!datasets.length) throw new Error('没有成功加载任何数据集文件');

                        buildAllCheckboxGroups(datasets);
                        applyFilters();
                    } catch (err) {
                        console.error(err);
                        filterError.textContent = '加载数据失败: ' + err.message;
                        filterError.style.display = 'block';
                    }
                }

                // === 标签生成部分（保持原逻辑） ===
                function buildAllCheckboxGroups(datasets) {
                    filters.innerHTML = '';
                    for (const [cnKey, enKey] of Object.entries(chineseToEnglishMapping)) {
                        if (["name", "description", "path", "id"].includes(enKey)) continue;
                        if (enKey === "item") {
                            buildItemTree(filters, cnKey, datasets);
                        } else {
                            const valueSet = new Set();
                            datasets.forEach(ds => {
                                if (Array.isArray(ds[enKey])) ds[enKey].forEach(v => v && valueSet.add(String(v)));
                                else if (ds[enKey]) valueSet.add(String(ds[enKey]));
                            });
                            buildGroup(filters, cnKey, enKey, valueSet);
                        }
                    }
                }

                function buildGroup(container, title, cssClass, valuesSet) {
                    const values = Array.from(valuesSet).sort();
                    let html = '<h5 class="mb-1">' + escapeHtml(title) + '</h5>';
                    html += '<div class="checkbox-container"><label><input type="checkbox" id="' + cssClass + '-all-checkbox" checked> 全部</label></div>';
                    values.forEach((val, i) => {
                        const id = cssClass + '-' + (i + 1);
                        html += '<div class="checkbox-container"><label><input type="checkbox" class="' + cssClass + '-checkbox" id="' + id + '" value="' + escapeHtml(val) + '"> ' + escapeHtml(val) + ' <small class="text-muted">(<span id="' + id + '-count">0</span>)</small></label></div>';
                    });
                    const block = document.createElement('div');
                    block.innerHTML = html;
                    container.appendChild(block);

                    block.addEventListener('change', (e) => {
                        const allBox = block.querySelector('#' + cssClass + '-all-checkbox');
                        const children = Array.from(block.querySelectorAll('.' + cssClass + '-checkbox'));
                        if (!allBox) return;
                        if (e.target === allBox) {
                            if (allBox.checked) children.forEach(cb => cb.checked = false);
                        } else if (e.target.classList.contains(cssClass + '-checkbox')) {
                            const any = children.some(cb => cb.checked);
                            allBox.checked = !any;
                        }
                        applyFilters();
                    });
                }

                function buildItemTree(container, title, datasets) {
                    const root = document.createElement('div');
                    root.innerHTML = '<h5 class="mb-1">' + escapeHtml(title) + '</h5>';
                    const tree = {};

                    datasets.forEach(ds => {
                        if (Array.isArray(ds.item)) {
                            let node = tree;
                            ds.item.forEach(it => {
                                if (!node[it.value]) node[it.value] = {};
                                node = node[it.value];
                            });
                        }
                    });

                    function renderNode(node, prefix) {
                        let html = '<ul>';
                        Object.keys(node).forEach((key, i) => {
                            const id = prefix + '-' + i;
                            const hasChild = Object.keys(node[key]).length > 0;
                            html += `<li>
                <label class="checkbox-container">
                  <input type="checkbox" class="item-checkbox" id="${id}" value="${escapeHtml(key)}">
                  ${escapeHtml(key)} <small class="text-muted">(<span id="${id}-count">0</span>)</small>
                </label>`;
                            if (hasChild) {
                                html += `<span class="tree-toggle">▶</span>
                         <div class="nested">${renderNode(node[key], id)}</div>`;
                            }
                            html += `</li>`;
                        });
                        html += '</ul>';
                        return html;
                    }

                    root.innerHTML += renderNode(tree, 'item');
                    container.appendChild(root);

                    root.addEventListener('click', (e) => {
                        if (e.target.classList.contains('tree-toggle')) {
                            const li = e.target.closest('li');
                            li.classList.toggle('expanded');
                            e.target.textContent = li.classList.contains('expanded') ? '▼' : '▶';
                        }
                    });

                    root.addEventListener('change', (e) => {
                        if (e.target.classList.contains('item-checkbox')) {
                            applyFilters();
                        }
                    });
                }

                // === 筛选逻辑 ===
                function applyFilters() {
                    selectedDatasets.clear(); // 筛选条件变化时清空选择
                    const q = (searchBox && searchBox.value) ? String(searchBox.value).trim().toLowerCase() : '';

                    currentDatasets = datasets.filter(ds => {
                        if (q) {
                            const name = String(ds.name || ds.path || '').toLowerCase();
                            if (!name.includes(q)) return false;
                        }
                        return true; // TODO: 保持原有复杂过滤逻辑，这里省略
                    });

                    totalPages = Math.max(1, Math.ceil(currentDatasets.length / itemsPerPage));
                    currentPage = 1;
                    renderVideos();
                }

                // === 渲染视频 ===
                function renderVideos() {
                    const start = (currentPage - 1) * itemsPerPage;
                    const pageData = currentDatasets.slice(start, start + itemsPerPage);
                    videoList.innerHTML = '';
                    pageData.forEach(ds => {
                        const col = document.createElement('div');
                        col.className = 'col-md-3 p-1 d-flex position-relative video-card';
                        if (selectedDatasets.has(ds.path)) col.classList.add('selected');

                        const video = document.createElement('video');
                        video.className = 'border w-100';
                        video.autoplay = true; video.loop = true; video.muted = true; video.playsInline = true;

                        const source = document.createElement('source');
                        source.src = 'videos/' + ds.path + '.mp4';
                        source.type = 'video/mp4';
                        video.appendChild(source);

                        const overlay = document.createElement('div');
                        overlay.className = 'video-overlay p-3';
                        overlay.innerHTML = `<span><b>${escapeHtml(ds.name || ds.path)}</b><br>${escapeHtml(ds.description || '')}</span>`;

                        col.appendChild(video);
                        col.appendChild(overlay);

                        col.addEventListener('click', () => {
                            if (selectedDatasets.has(ds.path)) {
                                selectedDatasets.delete(ds.path);
                                col.classList.remove('selected');
                            } else {
                                selectedDatasets.add(ds.path);
                                col.classList.add('selected');
                            }
                        });

                        videoList.appendChild(col);
                    });

                    pageInfo.textContent = '第 ' + currentPage + ' / 共 ' + totalPages + ' 页';
                    prevPageBtn.disabled = currentPage <= 1;
                    nextPageBtn.disabled = currentPage >= totalPages;
                }

                // === 全选 / 清空 / 下载 ===
                selectAllBtn.addEventListener('click', () => {
                    selectedDatasets.clear();
                    currentDatasets.forEach(ds => selectedDatasets.add(ds.path));
                    renderVideos();
                });

                clearSelectionBtn.addEventListener('click', () => {
                    selectedDatasets.clear();
                    renderVideos();
                });

                function generateDownloadCommand() {
                    const hub = document.querySelector('input[name="hubOption"]:checked').value;
                    let cmd = `python -m robotcoin.datasets.download --hub ${hub} --ds_lists " \\\n`;
                    selectedDatasets.forEach(path => {
                        cmd += path + " \\\n";
                    });
                    cmd += `"`;
                    document.getElementById('downloadCommand').value = cmd;
                }

                downloadBtn.addEventListener('click', () => {
                    generateDownloadCommand();
                    $('#downloadModal').modal('show');
                });

                document.querySelectorAll('input[name="hubOption"]').forEach(radio => {
                    radio.addEventListener('change', generateDownloadCommand);
                });

                // 翻页
                prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderVideos(); } });
                nextPageBtn.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderVideos(); } });
                if (searchBox) searchBox.addEventListener('input', applyFilters);

                loadDatasets();
            });
        })();
    </script>
</body>

</html>