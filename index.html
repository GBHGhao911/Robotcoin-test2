<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dataset Visualizer</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        }

        h1,
        h3 {
            font-weight: 600;
            background: linear-gradient(90deg, #007bff, #00c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* 给整个标签栏加滚动条 */
        #filters {
            max-height: 75vh;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
        }

        #filters h5 {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 10px;
            border-left: 3px solid #007bff;
            padding-left: 6px;
        }

        /* 去掉物品树的缩进 */
        #filters ul {
            list-style: none;
            padding-left: 0;
            margin-left: 0;
        }

        .video-card {
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 120px;
            cursor: pointer;
        }

        .video-card:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .video-card video {
            border-radius: 8px;
            background: #000;
            display: block;
        }

        .video-card.selected video {
            border: 3px solid orange !important;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.65);
            opacity: 0;
            transition: opacity 0.25s ease;
            color: white;
            display: flex;
            justify-content: center;
            text-align: center;
            align-items: center;
            font-size: 0.8rem;
            padding: 5px;
            z-index: 10;
            pointer-events: none;
        }

        .video-card:hover .video-overlay {
            opacity: 1;
        }

        .checkbox-container {
            font-size: 0.95rem;
            margin-bottom: -0.25rem;
        }

        .tree-toggle {
            cursor: pointer;
            color: gray;
            font-size: 0.9rem;
            display: inline-block;
            width: 1em;
            text-align: center;
            margin-left: 4px;
        }

        .nested {
            display: none;
        }

        .expanded>.nested {
            display: block;
        }

        #downloadCommand {
            font-family: monospace;
            background: #f5f5f5;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div class="container mt-3">
        <div class="row">
            <h1 class="d-md-block d-none">Dataset Visualizer</h1>
            <h3 class="d-block d-md-none">Dataset Visualizer</h3>
        </div>

        <div class="row">
            <div class="col-md-2 px-1 col-12">
                <div class="mb-2">
                    <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="搜索数据集名字">
                </div>
                <div class="btn-group d-flex mb-2" role="group">
                    <button id="selectAllBtn" class="btn btn-sm btn-outline-primary flex-fill">全选</button>
                    <button id="clearSelectionBtn" class="btn btn-sm btn-outline-secondary flex-fill">清空选择</button>
                    <button id="downloadBtn" class="btn btn-sm btn-outline-success flex-fill">下载</button>
                </div>
                <div id="filters"></div>
                <div id="filterError" style="color:red; display:none;"></div>
            </div>

            <div class="col">
                <div class="row" id="video-list"></div>
                <div class="d-flex justify-content-center my-3">
                    <button class="btn btn-outline-dark btn-sm mx-1" id="prevPage">上一页</button>
                    <span class="align-self-center" id="pageInfo"></span>
                    <button class="btn btn-outline-dark btn-sm mx-1" id="nextPage">下一页</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载命令模态框 -->
    <div class="modal fade" id="downloadModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">下载命令</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div>
                        <label><input type="radio" name="hubOption" value="huggingface" checked> HuggingFace</label>
                        <label class="ml-3"><input type="radio" name="hubOption" value="modelscope"> ModelScope</label>
                    </div>
                    <textarea id="downloadCommand" class="form-control mt-2" rows="8" readonly></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        const jsyamlLib = window.jsyaml;
        let datasets = [];
        let currentDatasets = [];
        let selectedDatasets = new Set();
        let currentPage = 1;
        const pageSize = 10;

        const filterSection = document.getElementById('filterSection');
        const itemFilter = document.getElementById('itemFilter');
        const filterError = document.getElementById('filterError');
        const videoList = document.getElementById('videoList');
        const pageInfo = document.getElementById('pageInfo');

        const chineseToEnglishMapping = {
            "数据集名称": "name",
            "简介": "description",
            "物品": "item",
            "声音传感器数量": "soundSensors",
            "触觉传感器数量": "tactileSensors"
        };
        async function loadDatasets() {
            try {
                const indexRes = await fetch('dataset_info/data_index.json');
                const fileList = await indexRes.json();

                datasets = [];
                let idCounter = 1;

                for (let f = 0; f < fileList.length; f++) {
                    const fileName = fileList[f];
                    const res = await fetch('dataset_info/' + fileName);
                    const yamlText = await res.text();
                    let raw = jsyamlLib.load(yamlText);
                    const ds = {};

                    for (const [cnKey, val] of Object.entries(raw || {})) {
                        const enKey = chineseToEnglishMapping[cnKey] || cnKey;

                        if (enKey === "description" && val !== undefined && val !== null) {
                            ds[enKey] = String(val);
                        } else if (enKey === "item") {
                            ds[enKey] = [];

                            let items = [];
                            if (Array.isArray(val)) {
                                items = val.slice();
                            } else if (typeof val === "object" && val !== null) {
                                items = Object.values(val);
                            } else if (val) {
                                items = [val];
                            }

                            for (let i = 0; i < items.length; i++) {
                                const itemObj = items[i];
                                const levels = [];

                                if (typeof itemObj === "object" && itemObj !== null) {
                                    for (let j = 1; j <= 5; j++) {
                                        const key = "level" + j;
                                        if (itemObj[key] && itemObj[key] !== "null") {
                                            levels.push(String(itemObj[key]).trim());
                                        }
                                    }
                                } else if (typeof itemObj === "string") {
                                    levels.push(...itemObj.trim().split('/'));
                                }

                                if (levels.length > 0) {
                                    ds[enKey].push(levels);
                                }
                            }
                        } else if (enKey === "soundSensors" || enKey === "tactileSensors") {
                            ds[enKey] = (val !== undefined && val !== null) ? String(val) : "0";
                        } else {
                            ds[enKey] = val;
                        }
                    }

                    ds.path = String(fileName).replace(/\.yml$/i, '');
                    ds.id = String(idCounter++);
                    datasets.push(ds);
                }

                buildAllCheckboxGroups(datasets);
                buildItemTree(datasets);
                applyFilters();
            } catch (err) {
                filterError.textContent = '加载数据失败: ' + err.message;
                filterError.style.display = 'block';
                console.error("加载数据失败:", err);
            }
        }

        function buildAllCheckboxGroups(datasets) {
            filterSection.innerHTML = '';

            for (const [cnKey, enKey] of Object.entries(chineseToEnglishMapping)) {
                if (["name", "description", "path", "id", "item"].includes(enKey)) continue;

                const valueSet = new Set();
                for (let i = 0; i < datasets.length; i++) {
                    const ds = datasets[i];
                    if (Array.isArray(ds[enKey])) {
                        for (let j = 0; j < ds[enKey].length; j++) {
                            valueSet.add(String(ds[enKey][j]).trim());
                        }
                    } else if (ds[enKey] !== undefined && ds[enKey] !== null) {
                        valueSet.add(String(ds[enKey]).trim());
                    }
                }

                if (valueSet.size > 0) {
                    buildGroup(filterSection, cnKey, enKey, valueSet);
                }
            }
        }

        function buildGroup(container, cnKey, enKey, values) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'filter-group';
            groupDiv.innerHTML = `<h5>${cnKey}</h5>`;

            const allId = enKey + "-all-checkbox";
            groupDiv.innerHTML += `<div class="checkbox-container">
                               <label>
                                 <input type="checkbox" id="${allId}" checked> 全部
                               </label>
                             </div>`;

            const valueArray = Array.from(values).sort();
            for (let i = 0; i < valueArray.length; i++) {
                const val = valueArray[i];
                const id = enKey + '-' + i;
                groupDiv.innerHTML += `<div class="checkbox-container">
                                 <label>
                                   <input type="checkbox" class="filter-checkbox" data-field="${enKey}" id="${id}" value="${val}">
                                   ${val} <small class="text-muted">(<span id="${id}-count">0</span>)</small>
                                 </label>
                               </div>`;
            }

            container.appendChild(groupDiv);

            groupDiv.addEventListener('change', (e) => {
                const allBox = document.getElementById(allId);
                const children = groupDiv.querySelectorAll('.filter-checkbox');

                if (e.target === allBox) {
                    if (allBox.checked) {
                        for (let i = 0; i < children.length; i++) {
                            children[i].checked = false;
                        }
                    }
                } else if (e.target.classList.contains("filter-checkbox")) {
                    let anyChecked = false;
                    for (let i = 0; i < children.length; i++) {
                        if (children[i].checked) {
                            anyChecked = true;
                            break;
                        }
                    }
                    allBox.checked = !anyChecked;
                }
                applyFilters();
            });
        }
        function buildItemTree(datasets) {
            const tree = {};

            // 构建分类树
            for (let i = 0; i < datasets.length; i++) {
                const ds = datasets[i];
                if (Array.isArray(ds.item)) {
                    for (let j = 0; j < ds.item.length; j++) {
                        const path = ds.item[j];
                        let node = tree;

                        if (Array.isArray(path)) {
                            for (let k = 0; k < path.length; k++) {
                                const level = path[k];
                                if (!node[level]) node[level] = {};
                                node = node[level];
                            }
                        } else if (typeof path === "string") {
                            const parts = path.trim().split('/');
                            for (let k = 0; k < parts.length; k++) {
                                const level = parts[k];
                                if (!node[level]) node[level] = {};
                                node = node[level];
                            }
                        }
                    }
                }
            }

            // 渲染树
            function renderNode(node, prefix) {
                let html = "<ul class='item-tree'>";
                const keys = Object.keys(node).sort();
                for (let i = 0; i < keys.length; i++) {
                    const key = keys[i];
                    const id = prefix + '-' + i;
                    const safeKey = escapeHtml(key);

                    html += `<li>
                     <label>
                       <input type="checkbox" class="item-checkbox" data-field="item" id="${id}" value="${safeKey}">
                       ${safeKey} 
                       <small class="text-muted">(<span id="${id}-count">0</span>)</small>
                     </label>`;
                    html += renderNode(node[key], id);
                    html += `</li>`;
                }
                html += "</ul>";
                return html;
            }

            const html = '<h5 class="mb-1">物品</h5>' +
                '<div class="checkbox-container"><label><input type="checkbox" id="item-all-checkbox" checked> 全部</label></div>' +
                renderNode(tree, "item");

            const block = document.createElement('div');
            block.innerHTML = html;
            itemFilter.appendChild(block);

            // 绑定事件
            block.addEventListener('change', (e) => {
                const allBox = document.getElementById("item-all-checkbox");
                const children = block.querySelectorAll('.item-checkbox');

                if (e.target === allBox) {
                    if (allBox.checked) {
                        for (let i = 0; i < children.length; i++) {
                            children[i].checked = false;
                        }
                    }
                } else if (e.target.classList.contains("item-checkbox")) {
                    let anyChecked = false;
                    for (let i = 0; i < children.length; i++) {
                        if (children[i].checked) {
                            anyChecked = true;
                            break;
                        }
                    }
                    allBox.checked = !anyChecked;
                }
                applyFilters();
            });
        }

        function applyFilters() {
            currentDatasets = [];
            const filterMap = {};

            const allCheckboxes = document.querySelectorAll('.filter-checkbox');
            for (let i = 0; i < allCheckboxes.length; i++) {
                const cb = allCheckboxes[i];
                if (cb.checked) {
                    const field = cb.dataset.field;
                    if (!filterMap[field]) filterMap[field] = new Set();
                    filterMap[field].add(cb.value);
                }
            }

            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            const itemSelected = [];
            for (let i = 0; i < itemCheckboxes.length; i++) {
                const cb = itemCheckboxes[i];
                if (cb.checked) {
                    itemSelected.push(cb.value);
                }
            }

            for (let i = 0; i < datasets.length; i++) {
                const ds = datasets[i];
                let match = true;

                for (const field in filterMap) {
                    if (filterMap[field].size > 0) {
                        if (Array.isArray(ds[field])) {
                            let hasMatch = false;
                            for (let j = 0; j < ds[field].length; j++) {
                                if (filterMap[field].has(ds[field][j])) {
                                    hasMatch = true;
                                    break;
                                }
                            }
                            if (!hasMatch) {
                                match = false;
                                break;
                            }
                        } else {
                            if (!filterMap[field].has(String(ds[field]))) {
                                match = false;
                                break;
                            }
                        }
                    }
                }

                if (itemSelected.length > 0) {
                    let itemMatch = false;
                    for (let j = 0; j < ds.item.length; j++) {
                        const path = ds.item[j];
                        if (Array.isArray(path)) {
                            for (let k = 0; k < path.length; k++) {
                                if (itemSelected.includes(path[k])) {
                                    itemMatch = true;
                                    break;
                                }
                            }
                        } else if (typeof path === "string") {
                            if (itemSelected.includes(path)) {
                                itemMatch = true;
                                break;
                            }
                        }
                    }
                    if (!itemMatch) match = false;
                }

                if (match) {
                    currentDatasets.push(ds);
                }
            }

            updateCounts();
            renderVideos();
        }

        function updateCounts() {
            // 更新普通复选框的计数
            const allCheckboxes = document.querySelectorAll('.filter-checkbox');
            for (let i = 0; i < allCheckboxes.length; i++) {
                const cb = allCheckboxes[i];
                const field = cb.dataset.field;
                const value = cb.value;
                let count = 0;

                for (let j = 0; j < currentDatasets.length; j++) {
                    const ds = currentDatasets[j];
                    if (Array.isArray(ds[field])) {
                        if (ds[field].includes(value)) count++;
                    } else if (String(ds[field]) === value) {
                        count++;
                    }
                }

                const el = document.getElementById(cb.id + "-count");
                if (el) el.textContent = count;
            }

            // 更新物品树的计数
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            for (let i = 0; i < itemCheckboxes.length; i++) {
                const cb = itemCheckboxes[i];
                let count = 0;
                for (let j = 0; j < currentDatasets.length; j++) {
                    const ds = currentDatasets[j];
                    for (let k = 0; k < ds.item.length; k++) {
                        const path = ds.item[k];
                        if (Array.isArray(path)) {
                            if (path.includes(cb.value)) {
                                count++;
                                break;
                            }
                        } else if (path === cb.value) {
                            count++;
                            break;
                        }
                    }
                }
                const el = document.getElementById(cb.id + "-count");
                if (el) el.textContent = count;
            }
        }

        function renderVideos() {
            videoList.innerHTML = '';
            const totalPages = Math.ceil(currentDatasets.length / pageSize);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = currentDatasets.slice(start, end);

            for (let i = 0; i < pageData.length; i++) {
                const ds = pageData[i];
                const div = document.createElement('div');
                div.className = 'video-card';
                div.innerHTML = `<h6>${ds.name || ds.path}</h6>
                         <pre>${ds.description || ""}</pre>`;
                videoList.appendChild(div);
            }

            pageInfo.textContent = `第 ${currentPage} / ${totalPages || 1} 页`;
        }

        document.getElementById('prevPageBtn').addEventListener('click', () => {
            currentPage--;
            renderVideos();
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            currentPage++;
            renderVideos();
        });

        document.getElementById('selectAllBtn').addEventListener('click', () => {
            for (let i = 0; i < currentDatasets.length; i++) {
                selectedDatasets.add(currentDatasets[i].path);
            }
            generateDownloadCommand();
        });

        document.getElementById('downloadBtn').addEventListener('click', generateDownloadCommand);

        function generateDownloadCommand() {
            const hubOption = document.querySelector('input[name="hubOption"]:checked').value;
            const paths = Array.from(selectedDatasets).sort();
            let cmd = "";

            for (let i = 0; i < paths.length; i++) {
                const path = paths[i];
                if (hubOption === "huggingface") {
                    cmd += `huggingface-cli download ${path}\n`;
                } else {
                    cmd += `openxlab download ${path}\n`;
                }
            }

            document.getElementById('downloadCmd').value = cmd;
        }

        const radios = document.querySelectorAll('input[name="hubOption"]');
        for (let i = 0; i < radios.length; i++) {
            radios[i].addEventListener('change', generateDownloadCommand);
        }

        function escapeHtml(text) {
            return text.replace(/[&<>"']/g, function (m) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[m];
            });
        }

        loadDatasets();
    </script>
</body>

</html>